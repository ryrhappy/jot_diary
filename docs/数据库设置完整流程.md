# Jot Diary 数据库设置完整流程

## 📋 前置准备

1. **确保已创建 Supabase 项目**
   - 访问 [Supabase](https://supabase.com/)
   - 创建新项目或使用现有项目

2. **获取 API 密钥**
   - 进入 Supabase 项目
   - 点击左侧菜单 **Settings** > **API**
   - 复制以下信息（稍后需要配置到项目中）：
     - `Project URL` → `NEXT_PUBLIC_SUPABASE_URL`
     - `anon public` key → `NEXT_PUBLIC_SUPABASE_ANON_KEY`

---

## 🗄️ 数据库设置步骤

### 步骤 1: 执行数据库建表脚本

1. 在 Supabase 项目中，点击左侧菜单 **SQL Editor**
2. 点击 **New query** 创建新查询
3. 复制 `docs/database_setup_complete.sql` 文件的全部内容
4. 粘贴到 SQL Editor 中
5. 点击 **Run** 或按 `Ctrl/Cmd + Enter` 执行

**预期结果**：
- ✅ 成功创建 `diaries` 表
- ✅ 创建了必要的索引
- ✅ 启用了 RLS（行级安全策略）
- ✅ 创建了 4 个安全策略

### 步骤 2: 验证表结构（可选）

在 SQL Editor 中执行以下查询验证表结构：

```sql
SELECT 
  column_name, 
  data_type, 
  is_nullable,
  column_default
FROM information_schema.columns 
WHERE table_name = 'diaries'
ORDER BY ordinal_position;
```

**预期结果**：应该看到以下字段：
- `id` (text, NOT NULL)
- `content` (text, NOT NULL)
- `time` (text, NOT NULL)
- `date` (date, NOT NULL)
- `category` (text, NOT NULL)
- `completed` (boolean, nullable)
- `created_at` (timestamp with time zone, nullable, default: now())
- `user_id` (uuid, NOT NULL)

### 步骤 3: 验证 RLS 策略（可选）

执行以下查询验证安全策略：

```sql
SELECT 
  policyname,
  cmd
FROM pg_policies 
WHERE tablename = 'diaries';
```

**预期结果**：应该看到 4 个策略：
- `Users can view own diaries` (SELECT)
- `Users can insert own diaries` (INSERT)
- `Users can update own diaries` (UPDATE)
- `Users can delete own diaries` (DELETE)

---

## ⚙️ 项目配置

### 步骤 4: 配置环境变量

1. **本地开发环境**：
   - 在项目根目录创建或编辑 `.env.local` 文件
   - 添加以下内容：

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

2. **Vercel 部署环境**：
   - 进入 Vercel 项目设置
   - 点击 **Environment Variables**
   - 添加以下变量：
     - `NEXT_PUBLIC_SUPABASE_URL`
     - `NEXT_PUBLIC_SUPABASE_ANON_KEY`

---

## 🧪 测试验证

### 步骤 5: 测试应用功能

1. **启动开发服务器**：
   ```bash
   npm run dev
   ```

2. **测试用户注册/登录**：
   - 打开应用
   - 点击"登录"按钮
   - 注册新账户或登录现有账户

3. **测试数据操作**：
   - ✅ 创建新日记条目
   - ✅ 查看日记列表（应该只看到自己的数据）
   - ✅ 编辑日记条目
   - ✅ 删除日记条目

4. **测试数据隔离**（可选）：
   - 使用不同账户登录
   - 验证只能看到自己的数据
   - 验证无法访问其他用户的数据

---

## 🔒 安全说明

### 数据隔离机制

本项目采用**双重保护**机制确保数据安全：

1. **应用层过滤**：
   - 所有数据库查询自动添加 `user_id` 过滤条件
   - 代码位置：`src/store/useDiaryStore.ts`

2. **数据库层保护（RLS）**：
   - 使用 Supabase 行级安全策略
   - 即使应用层有漏洞，数据库也会阻止跨用户访问
   - 策略位置：`docs/database_setup_complete.sql`

### 安全策略说明

- **SELECT 策略**：用户只能查询 `user_id` 等于自己用户 ID 的记录
- **INSERT 策略**：插入时自动验证 `user_id` 必须等于当前登录用户
- **UPDATE 策略**：只能更新自己的记录，且更新后 `user_id` 不能改变
- **DELETE 策略**：只能删除自己的记录

---

## ❓ 常见问题

### Q1: 执行 SQL 时提示表已存在？
**A**: 如果表已存在，可以执行以下命令删除后重建：
```sql
DROP TABLE IF EXISTS diaries CASCADE;
```
然后重新执行 `database_setup_complete.sql`

### Q2: 如何查看当前登录用户？
**A**: 在应用中，登录后点击右上角用户图标，会显示当前用户邮箱。

### Q3: 如何重置数据库？
**A**: 执行以下 SQL：
```sql
DROP TABLE IF EXISTS diaries CASCADE;
```
然后重新执行 `database_setup_complete.sql`

### Q4: 忘记密码怎么办？
**A**: 在登录界面点击"忘记密码"，输入邮箱后会收到重置密码邮件。

---

## 📝 总结

完成以上步骤后，您的 Jot Diary 应用将具备：
- ✅ 完整的用户认证系统
- ✅ 安全的数据隔离机制
- ✅ 高性能的数据库索引
- ✅ 符合最佳实践的安全策略

现在可以开始使用应用了！🎉

