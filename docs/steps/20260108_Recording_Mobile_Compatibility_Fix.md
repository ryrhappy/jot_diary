# 录音功能手机端兼容性深度优化

## 用户反馈问题
在手机浏览器中点击录音按钮，录音组件会“闪现”一下就消失，无法进行录音，而在电脑端正常。

## 问题分析
1. **用户手势丢失（User Gesture Loss）**：移动端浏览器（尤其是 iOS Safari）对麦克风等敏感权限的调用有极严格限制。原代码中使用了 `setTimeout(..., 50)` 来启动语音识别，这会导致调用链脱离了原始的点击事件手势，从而被浏览器静默拦截或抛出错误。
2. **错误处理逻辑过激**：原代码在 `onerror` 事件发生时立即执行 `setIsSttActive(false)`，导致组件瞬间关闭。如果发生即时错误（如权限拦截、非 HTTPS 限制等），用户只能看到组件“闪现”消失，无法看到错误提示。
3. **Safari 特有兼容性**：iOS Safari 对 `SpeechRecognition.continuous` 参数支持较差，设置为 `true` 时常导致识别无法正常开始或过早结束。

## 修改内容
1. **同步启动识别**：移除了 `handleStartSTT` 中的 `setTimeout`，确保 `recognition.start()` 在点击事件的同步执行流中触发，从而正确携带用户手势。
2. **优化错误展示**：
   - 引入了 `sttError` 状态。
   - 在发生错误时不再自动关闭组件，而是在界面中展示具体的错误信息（如权限提示、HTTPS 提示等）。
   - 针对 iOS Safari 提供了更详细的权限授予引导。
   - 增加了“点击重试”按钮，方便用户在调整权限后快速恢复。
3. **针对性参数调整**：
   - 自动检测是否为 Safari 浏览器，并在 Safari 上禁用 `continuous` 模式以提高启动稳定性。
   - 增加了对 `service-not-allowed` 错误的捕获。
4. **状态重置优化**：
   - 在手动取消或确认转文字时，显式调用 `stopSTT()` 并重置所有相关状态，防止残留进程影响下一次录音。

## 测试建议
- **HTTPS 环境**：请确保在 HTTPS 环境下访问（本地开发请使用 `localhost`）。
- **权限检查**：如果提示权限错误，请检查浏览器地址栏左侧的设置，确保已允许麦克风访问。
- **浏览器推荐**：iOS 推荐使用自带 Safari 浏览器，Android 推荐使用 Chrome 浏览器。

